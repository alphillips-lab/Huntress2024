# Revenge of Discount Programming Devices

## Description

<small>Author: @sudo_Rem</small><br><br>One of our security analysts learned to avoid printing out flag when obfuscating code!<br> Unfortunately, now they've lost that flag.<br> Maybe you can help them get it back. <br><br> <b>Download the file(s) below.</b>


## Files

* [challenge](<files/challenge>)

## Solution

This file is a subtle knod to the original discount programming devices challenges, which ended up being accidentally broken.

This challenge is slightly more challenging, now being wrapped in a PyInstaller binary. The same general logic applies, where the python is obfuscated through Base64 and compression several times, but there is also a 2nd stage where there is some XOR decryption that takes place in between this obfuscation.

I created a script using Binary Refinery to solve the challenge, it accepts the original binary as input:

```python
import refinery.shell as r
import sys

data = r.ef(sys.argv[1]) | r.xtpyi("challenge.pyc") | r.rev() | r.carve("b64", "-l", "-t", "1") | r.snip("1:") | ... 
data = data | r.b64() | r.zl() | ...

while True:
    data = data | r.rev() | r.carve("b64", "-l", "-t", "1") | r.b64() | r.zl() | ...
    if b"decode" in data or b"#" in data:
        break

data = data | r.carve("intarray") |r.pack | ... 
v = data.decode().split(";")
v1 = v[5] # key
v2 = v[6] # data
exec(v1)
exec(v2)
data = __ | r.xor(_) | ...

while True:
    data = data | r.rev() | r.carve("b64", "-l", "-t", "1") | r.b64() | r.zl() | ...
    if b"decode" in data or b"#" in data:
        break

print(data.decode())

```

Lukas on team unremarkable also spent some time creating a super optimized one-line Binary Refinery pipeline, because he is just that good!

```
r.emit ./challenge | r.xtpyi challenge.pyc | r.rev | r.carve b64 -s | r.snip 1: | r.b64 | r.zl | r.loop 49 'rev:csd[b64]:zl' | r.carve intarray | r.pack | python3 | r.loop 50 'rev:csd[b64]:zl'
```

Althought not necessary in this case, `pycdc` is a helpful tool for dealing with compiled python files:

https://github.com/zrax/pycdc